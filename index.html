<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">


<!-- ICONOS -->
<link rel="icon" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:'Orbitron', monospace;
  display:flex;
  justify-content:center;
}
.app{
  width:100%;
  max-width:390px;
  min-height: calc(100vh - env(safe-area-inset-top,16px) - env(safe-area-inset-bottom,16px));
  display:flex;
  flex-direction:column;
  justify-content:center;
  /* padding: top/right/bottom with safe-area insets for iPhone notch/home */
  padding: calc(env(safe-area-inset-top,12px) + 12px) 16px calc(env(safe-area-inset-bottom,12px) + 12px);
}

@media (max-width:360px){
  .app{ max-width:100%; padding: calc(env(safe-area-inset-top,8px) + 8px) 12px calc(env(safe-area-inset-bottom,8px) + 8px); }
  .grid{gap:8px}
  .box{padding:10px}
}

/* CUADRADOS */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.box{border:1px solid #fff;padding:12px;text-align:center}
.big{font-size:22px}
.mid{font-size:16px}
.small{font-size:12px;color:#aaa}

.line{border-top:1px solid #444;margin:10px 0}

/* CALENDARIO */
.calendar .week,.calendar .days{
  display:grid;grid-template-columns:repeat(7,1fr);text-align:center
}
.week{font-size:11px;opacity:.6}
.day{
  border:1px solid #333;
  padding:9px 0;
  margin:3px;
  border-radius:6px;
}
.work{background:#fff;color:#000}
.festivo{outline:2px solid #fff}

/* POPUPS */
.overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  justify-content:center;
  align-items:center;
}
.popup{
  border:1px solid #fff;
  padding:18px;
  width:85%;
}
.popup button{
  width:100%;
  margin:6px 0;
  padding:10px;
  background:#000;
  color:#fff;
  border:1px solid #fff;
  font-family:inherit;
  font-size:13px;
}

.hist-btn{
  margin-top:10px;
  border:1px solid #444;
  padding:6px;
  font-size:11px;
  text-align:center;
}
.almost{ color:#2ecc71; font-weight:700 }
</style>
</head>

<body>
<div class="app">

<!-- ARRIBA -->
<div>

<div class="grid">
  <div class="box">
    <div class="small">HOY</div>
    <div class="big" id="todayTime">00:00</div>
    <div class="mid" id="todayMoney">0.00 ‚Ç¨</div>
    <div class="small" id="todayRemaining">Te queda de curro real: 00:00:00</div>
  </div>
  <div class="box">
    <div class="small">TOTAL VIDA ‚Ç¨</div>
      <div class="big" id="lifeMoney">0.00</div>
      <div class="small" id="lifeInfo">8.597 ‚Ç¨ ‚Üí 622,75</div>
  </div>
  <div class="box">
    <div class="small">MES ‚Ç¨</div>
    <div class="big" id="monthMoney">0.00</div>
  </div>
  <div class="box">
    <div class="small">RACHA</div>
    <div class="big" id="streak">üî•0</div>
  </div>
</div>

<div class="line"></div>

<div class="grid">
  <div class="box">
    <div class="small">MA√ëANA</div>
    <div class="mid" id="morningDays">0</div>
  </div>
  <div class="box">
    <div class="small">TARDE</div>
    <div class="mid" id="afternoonDays">0</div>
  </div>
</div>

<div style="display:flex;gap:8px;margin-top:10px;justify-content:center;">
  <div id="undoBtn" class="hist-btn" style="display:none;" onclick="undoRemove()">DESHACER</div>
</div>

</div>

<!-- ABAJO -->
<div class="calendar">
  <div class="week">
    <div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
  </div>
  <div class="days" id="calendar"></div>
</div>

</div>

<!-- POPUP DIA -->
<div class="overlay" id="dayPopup">
  <div class="popup">
    <button onclick="setDay('ma√±ana',false)">Ma√±ana</button>
    <button onclick="setDay('tarde',false)">Tarde</button>
    <button onclick="setDay('tarde',true)">Festivo (x2)</button>
    <button onclick="setDay('ma√±ana',true)">Ma√±ana festivo (x2)</button>
    <button onclick="setOffDay()">FIESTA</button>
    <button onclick="removeDay()">Quitar d√≠a</button>
    <button onclick="closeDay()">Cancelar</button>
  </div>
</div>

<!-- HISTORIAL -->
<!-- SETTINGS POPUP -->
<div class="overlay" id="settingsPopup">
  <div class="popup">
    <div style="text-align:left">
      <label>Inicial ‚Ç¨</label>
      <input id="initMoney" type="number" step="0.01" style="width:100%;margin:6px 0;padding:8px;background:#000;color:#fff;border:1px solid #fff">
      <label>Inicial horas</label>
      <input id="initHours" type="number" step="0.01" style="width:100%;margin:6px 0;padding:8px;background:#000;color:#fff;border:1px solid #fff">
    </div>
    <button onclick="saveSettings()">Guardar</button>
    <button onclick="closeSettings()">Cancelar</button>
  </div>
</div>

<script>
const RATE=0.23;
const SHIFTS={
  ma√±ana:{s:420,e:840},
  tarde:{s:840,e:1230}
};

let days=JSON.parse(localStorage.getItem("days"))||{};
let months=JSON.parse(localStorage.getItem("months"))||{};

// Valores iniciales solicitados por el usuario
let INITIAL_LIFE_MONEY = 8597; // euros
let INITIAL_LIFE_HOURS = 622.75; // horas
let INITIAL_LIFE_MIN = Math.round(INITIAL_LIFE_HOURS * 60);

let selDay=null;
let lastRemoved=null;
const now=new Date();
const y=now.getFullYear(), m=now.getMonth(), d=now.getDate();
const monthKey=`${y}-${m+1}`;

function k(day){return `${monthKey}-${day}`}

function fmtNumber(n){
  return Number(n).toLocaleString('es-ES', {minimumFractionDigits:2, maximumFractionDigits:2});
}

function openDay(day){
  selDay=day;
  document.getElementById("dayPopup").style.display="flex";
}
function closeDay(){
  document.getElementById("dayPopup").style.display="none";
}
function setDay(shift,festivo){
  // set a working shift; ensure 'off' flag removed
  days[k(selDay)]={shift,festivo};
  if(days[k(selDay)].off) delete days[k(selDay)].off;
  localStorage.setItem("days",JSON.stringify(days));
  closeDay(); render();
}

function setOffDay(){
  // mark selected day as off/fiesta so it doesn't count
  days[k(selDay)]={off:true};
  localStorage.setItem("days",JSON.stringify(days));
  closeDay(); render();
}

function removeDay(){
  if(selDay==null) return closeDay();
  const key = k(selDay);
  if(days[key]){
    if(!confirm('¬øQuitar el d√≠a seleccionado?')) return;
    lastRemoved = { key, data: days[key] };
    delete days[key];
    localStorage.setItem("days",JSON.stringify(days));
    document.getElementById('undoBtn').style.display = 'block';
  }
  closeDay(); render();
}

function undoRemove(){
  if(!lastRemoved) return;
  days[lastRemoved.key] = lastRemoved.data;
  localStorage.setItem("days",JSON.stringify(days));
  lastRemoved = null;
  document.getElementById('undoBtn').style.display = 'none';
  render();
}

// helper: busca el siguiente turno en los pr√≥ximos 60 d√≠as
function findNextShift(fromDate){
  for(let i=0;i<60;i++){
    const d = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate()+i);
    const key = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
    const conf = days[key];
    if(conf && !conf.off && conf.shift) return {date:d, conf};
  }
  return null;
}

/* history UI removed */

function render(){
  const cal=document.getElementById("calendar");
  cal.innerHTML="";
  const daysInMonth=new Date(y,m+1,0).getDate();

  let totalMin=0, monthMin=0, morning=0, afternoon=0;

  // totalMin: sumar solo los d√≠as explicitados en `days` (ignorando 'off')
  Object.keys(days).forEach(kd=>{
    const conf=days[kd];
    if(conf.off) return;
    if(!conf.shift) return;
    let min = SHIFTS[conf.shift].e - SHIFTS[conf.shift].s;
    if(conf.festivo) min *= 2;
    totalMin += min;
  });

  // monthMin y contadores: recorrer cada d√≠a del mes y usar 'tarde' por defecto cuando no est√© marcado
  for(let i=1;i<=daysInMonth;i++){
    const key = k(i);
    const conf = days[key];
    if(conf && conf.off) continue; // skip fiesta
    const shift = (conf && conf.shift) ? conf.shift : 'tarde';
    let min = SHIFTS[shift].e - SHIFTS[shift].s;
    if(conf && conf.festivo) min *= 2;
    monthMin += min;
    shift === 'ma√±ana' ? morning++ : afternoon++;
  }

  // actualizar UI
  document.getElementById("monthMoney").innerText=fmtNumber(monthMin*RATE);
  // guardar por mes
  months[monthKey]=parseFloat((monthMin*RATE).toFixed(2));
  localStorage.setItem("months",JSON.stringify(months));

  // Incluir valores iniciales en el total de vida
  const lifeMoneyTotal = INITIAL_LIFE_MONEY + (totalMin * RATE);
  document.getElementById("lifeMoney").innerText = fmtNumber(lifeMoneyTotal);
  const lifeHoursTotal = INITIAL_LIFE_HOURS + (totalMin / 60);
  document.getElementById("lifeInfo").innerText = `${fmtNumber(lifeMoneyTotal)} ‚Ç¨ ‚Üí ${lifeHoursTotal.toLocaleString('es-ES', {minimumFractionDigits:2, maximumFractionDigits:2})} h`;

  document.getElementById("morningDays").innerText=morning;
  document.getElementById("afternoonDays").innerText=afternoon;
  // calcular racha: contar d√≠as consecutivos hacia atr√°s desde hoy
  // - d√≠as sin marcar cuentan como trabajados
  // - d√≠as marcados con `off` rompen la racha
  function computeStreak(){
    let streak = 0;
    const todayDate = new Date();
    for(let i=0;i<365;i++){
      const d = new Date(todayDate.getFullYear(), todayDate.getMonth(), todayDate.getDate()-i);
      const key = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
      const conf = days[key];

      if(conf && conf.off){
        // fiesta expl√≠cita: rompe la racha
        break;
      }

      if(conf && (conf.shift || conf.festivo)){
        // d√≠a marcado (ma√±ana/tarde) o festivo doble: cuenta como trabajado
        streak++;
        continue;
      }

      if(!conf){
        // d√≠a no marcado: lo tratamos como trabajado (suma a la racha)
        streak++;
        continue;
      }

      // cualquier otra configuraci√≥n expl√≠cita inesperada rompe la racha
      break;
    }
    return streak;
  }

  document.getElementById("streak").innerText = "üî•" + computeStreak();

  for(let i=1;i<=daysInMonth;i++){
    const el=document.createElement("div");
    el.className="day";
    el.textContent=i;
    const conf = days[k(i)];
    if(conf){
      if(conf.off){ el.classList.add('festivo'); }
      else { el.classList.add('work'); if(conf.festivo) el.classList.add('festivo'); }
    }
    el.onclick=()=>openDay(i);
    cal.appendChild(el);
  }
}

render();

// Countdown for 'curro real' today (resta 1h por d√≠a para cambio/merienda)
function pad(n){return n.toString().padStart(2,'0');}
function formatSeconds(sec){
  if(sec<=0) return '00:00:00';
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = Math.floor(sec%60);
  return `${pad(h)}:${pad(m)}:${pad(s)}`;
}

function updateTodayRemaining(){
  const now = new Date();
  const nowSec = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
  const el = document.getElementById('todayRemaining');
  const todayKey = k(d);
  const todayConf = days[todayKey];

  // si hoy est√° marcado como 'off', buscamos siguiente turno
  if(todayConf && todayConf.off){
    // fallthrough: buscar siguiente turno m√°s abajo
  } else {
    // usar la configuraci√≥n de hoy si existe y tiene shift, sino usar 'tarde' por defecto
    const usedConf = (todayConf && todayConf.shift) ? todayConf : { shift: 'tarde', festivo: false };
    const baseStart = SHIFTS[usedConf.shift].s;
    const baseDuration = SHIFTS[usedConf.shift].e - SHIFTS[usedConf.shift].s;
    const durationMin = usedConf.festivo ? baseDuration * 2 : baseDuration;
    const startMin = baseStart;
    const endMin = startMin + durationMin;
    const startSec = startMin * 60;
    const endSec = endMin * 60;

    if(nowSec < startSec){
      const untilStart = startSec - nowSec;
      el.classList.remove('almost');
      el.innerText = `${formatSeconds(untilStart)}`; // compacto: s√≥lo cadena
      return;
    }

    if(nowSec >= startSec && nowSec < endSec){
      const totalRemaining = endSec - nowSec;
      const remainingSec = Math.max(0, totalRemaining - 3600);
      if(remainingSec > 0 && remainingSec <= 3600) el.classList.add('almost'); else el.classList.remove('almost');
      el.innerText = `${formatSeconds(remainingSec)}`; // compacto: s√≥lo cadena
      return;
    }
  }

  // si no hay turno hoy (o es off / ya pas√≥), buscar siguiente turno
  const next = findNextShift(new Date());
  if(!next){ el.classList.remove('almost'); el.innerText = 'No hay turnos programados'; return; }
  // calcular segundos hasta el inicio del siguiente turno
  const startMinNext = SHIFTS[next.conf.shift].s;
  const startHour = Math.floor(startMinNext/60);
  const startMin = startMinNext%60;
  const nextStart = new Date(next.date.getFullYear(), next.date.getMonth(), next.date.getDate(), startHour, startMin, 0);
  let secsUntil = Math.floor((nextStart.getTime() - now.getTime())/1000);
  if(secsUntil < 0) secsUntil = 0;
  // formatear compacto: e.g. "2d 05:30" o "05:30"
  const daysLeft = Math.floor(secsUntil/86400);
  const hoursLeft = Math.floor((secsUntil%86400)/3600);
  const minsLeft = Math.floor((secsUntil%3600)/60);
  el.classList.remove('almost');
  if(daysLeft>0) el.innerText = `${daysLeft}d ${pad(hoursLeft)}:${pad(minsLeft)}`;
  else el.innerText = `${pad(hoursLeft)}:${pad(minsLeft)}`;
}

updateTodayRemaining();
setInterval(updateTodayRemaining, 1000);

// SETTINGS popup handlers
function openSettings(){
  document.getElementById('initMoney').value = INITIAL_LIFE_MONEY;
  document.getElementById('initHours').value = INITIAL_LIFE_HOURS;
  document.getElementById('settingsPopup').style.display = 'flex';
}
function closeSettings(){
  document.getElementById('settingsPopup').style.display = 'none';
}
function saveSettings(){
  const m = parseFloat(document.getElementById('initMoney').value) || 0;
  const h = parseFloat(document.getElementById('initHours').value) || 0;
  INITIAL_LIFE_MONEY = m; INITIAL_LIFE_HOURS = h; INITIAL_LIFE_MIN = Math.round(h*60);
  localStorage.setItem('INITIAL_LIFE_MONEY', INITIAL_LIFE_MONEY);
  localStorage.setItem('INITIAL_LIFE_HOURS', INITIAL_LIFE_HOURS);
  closeSettings(); render();
}
</script>

</body>
</html>
