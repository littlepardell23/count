<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Work</title>

<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="icon.png">

<style>
@font-face {
  font-family: Digital;
  src: url('https://fonts.gstatic.com/s/digital7/d-6IYplOFocCacKzxw.ttf');
}

body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: Arial, sans-serif;
}

.app {
  padding: 20px;
  text-align: center;
}

.label {
  font-size: 11px;
  opacity: .6;
  margin-top: 14px;
}

.num {
  font-family: Digital;
  font-size: 38px;
}

.big {
  font-size: 64px;
}

.line {
  height: 1px;
  background: #fff;
  opacity: .2;
  margin: 18px 0;
}

.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
}

.week {
  font-size: 10px;
  opacity: .5;
}

.day {
  border: 1px solid #333;
  border-radius: 6px;
  padding: 6px 0;
  font-size: 11px;
}

.day.red {
  background: #400;
}

input {
  width: 90%;
  background: #000;
  color: #fff;
  border: 1px solid #333;
  font-size: 10px;
}
</style>
</head>

<body>
<div class="app">

<div class="label">HOY</div>
<div class="num" id="todayTime">00:00</div>

<div class="label">HOY €</div>
<div class="num">€ <span id="todayMoney">0,00</span></div>

<div class="line"></div>

<div class="label">TOTAL HORAS</div>
<div class="num big" id="totalTime">0:00</div>

<div class="label">TOTAL €</div>
<div class="num big">€ <span id="totalMoney">0,00</span></div>

<div class="line"></div>

<div class="label">DÍAS SEGUIDOS</div>
<div class="num" id="streakWork">0</div>

<div class="label">DÍAS DE FIESTA</div>
<div class="num" id="streakOff">0</div>

<div class="line"></div>

<div class="calendar" id="calendar"></div>

</div>

<script>
const PRICE = 15;
const STORE = "workApp";
let data = JSON.parse(localStorage.getItem(STORE)) || {};

function save() {
  localStorage.setItem(STORE, JSON.stringify(data));
}

function hours(start, end) {
  if (!start || !end) return 0;
  return (new Date(`1970-01-01T${end}`) -
          new Date(`1970-01-01T${start}`)) / 36e5;
}

function renderCalendar() {
  const cal = document.getElementById("calendar");
  cal.innerHTML = "";
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth();
  const last = new Date(y, m + 1, 0).getDate();
  const week = ["L","M","X","J","V","S","D"];

  week.forEach(d => {
    const w = document.createElement("div");
    w.className = "week";
    w.textContent = d;
    cal.appendChild(w);
  });

  for (let d = 1; d <= last; d++) {
    const key = `${y}-${m+1}-${d}`;
    if (!data[key]) data[key] = { off:false, start:"", end:"" };

    const box = document.createElement("div");
    box.className = "day";
    if (data[key].off) box.classList.add("red");

    box.innerHTML = `
      <div>${d}</div>
      <input type="time" value="${data[key].start}">
      <input type="time" value="${data[key].end}">
    `;

    const inputs = box.querySelectorAll("input");

    inputs[0].onchange = e => {
      data[key].start = e.target.value;
      data[key].off = false;
      save(); calc();
    };

    inputs[1].onchange = e => {
      data[key].end = e.target.value;
      data[key].off = false;
      save(); calc();
    };

    box.onclick = e => {
      if (e.target.tagName === "INPUT") return;
      data[key].off = !data[key].off;
      save(); renderCalendar(); calc();
    };

    cal.appendChild(box);
  }
}

function calc() {
  let totalH = 0;
  let todayH = 0;
  let worked = [];
  let off = [];

  const today = new Date();
  const todayKey = `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`;

  for (let k in data) {
    if (data[k].off) {
      off.push(k);
      continue;
    }

    const h = hours(data[k].start, data[k].end);
    if (h > 0) {
      worked.push(k);
      totalH += h;
      if (k === todayKey) todayH = h;
    }
  }

  document.getElementById("totalTime").textContent =
    Math.floor(totalH) + ":" + String(Math.round((totalH%1)*60)).padStart(2,"0");

  document.getElementById("totalMoney").textContent =
    (totalH * PRICE).toLocaleString("es-ES",{minimumFractionDigits:2});

  document.getElementById("todayTime").textContent =
    Math.floor(todayH) + ":" + String(Math.round((todayH%1)*60)).padStart(2,"0");

  document.getElementById("todayMoney").textContent =
    (todayH * PRICE).toLocaleString("es-ES",{minimumFractionDigits:2});

  worked.sort();
  off.sort();

  let sw = 0;
  for (let i = worked.length - 1; i >= 0; i--) {
    if (i === worked.length - 1 ||
        new Date(worked[i+1]) - new Date(worked[i]) === 86400000) sw++;
    else break;
  }

  let so = 0;
  for (let i = off.length - 1; i >= 0; i--) {
    if (i === off.length - 1 ||
        new Date(off[i+1]) - new Date(off[i]) === 86400000) so++;
    else break;
  }

  document.getElementById("streakWork").textContent = sw;
  document.getElementById("streakOff").textContent = so;
}

renderCalendar();
calc();
setInterval(calc, 1000);
</script>
</body>
</html>
